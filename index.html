<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JUNIOR ASSOCIATE | Public Law</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Playfair+Display:ital,wght@0,600;0,700;1,400&family=Merriweather:ital,wght@0,300;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-green: #00e676;
            --accent-red: #ff5252;
            --accent-blue: #2979ff;
            --accent-gold: #ffd700;
            --paper-bg: #f4f1ea;
            --paper-text: #2c2c2c;
            --border-color: #333;
            --font-serif: 'Playfair Display', serif;
            --font-body: 'Merriweather', serif;
            --font-mono: 'Fira Code', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-mono);
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 900px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            background-color: var(--panel-bg);
            position: relative;
        }

        /* --- HEADER --- */
        header {
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            background: #181818;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
            z-index: 10;
            position: relative;
        }

        .case-id { font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        
        .game-header-elements { display: none; align-items: center; gap: 15px; width: 100%; justify-content: space-between; }
        .trust-container { width: 150px; text-align: right; }
        .trust-label { font-size: 0.6rem; display: block; margin-bottom: 3px; color: var(--text-secondary); }
        .progress-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; width: 50%; background: var(--accent-blue); transition: width 0.5s ease, background 0.5s ease; }
        
        .btn-exit {
            background: transparent; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; padding: 5px;
        }
        .btn-exit:hover { color: var(--accent-red); }

        /* Timer Bar */
        #timer-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: transparent; z-index: 15;
            display: none; 
        }
        #timer-bar { height: 100%; background: var(--accent-green); width: 100%; transition: width 1s linear, background-color 0.5s; }

        /* --- MENU SCREEN --- */
        #menu-screen {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }

        .menu-header { text-align: center; margin-bottom: 10px; padding-top: 10px; }
        .menu-title { font-family: var(--font-serif); font-size: 1.8rem; color: #fff; margin-bottom: 5px; }
        .menu-subtitle { font-size: 0.8rem; color: var(--text-secondary); }

        /* Global Progress */
        .global-progress-container { margin-bottom: 20px; padding: 0 10px; }
        .global-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--accent-gold); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .global-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .global-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-gold)); width: 0%; transition: width 0.5s ease; }

        .archive-link { text-align: center; margin-bottom: 10px; }
        .btn-archive {
            background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary);
            padding: 8px 20px; font-family: var(--font-mono); font-size: 0.8rem; cursor: pointer; text-transform: uppercase;
            border-radius: 4px; transition: all 0.2s;
        }
        .btn-archive:hover { border-color: var(--accent-blue); color: #fff; }

        .case-card {
            background: #252525; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px; transition: transform 0.2s; cursor: pointer;
        }
        .case-card:hover { border-color: var(--text-secondary); background: #2a2a2a; }
        .case-card.completed { border-color: var(--accent-green); }
        .case-card.complex { border-left: 3px solid var(--accent-gold); }
        .case-card.exam-card { border: 2px solid #333; background: #151515; margin-top: 20px; text-align: center; align-items: center; cursor: default; }
        .case-card.exam-card.unlocked { border-color: var(--accent-gold); cursor: pointer; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% {box-shadow: 0 0 0 rgba(255, 215, 0, 0);} 50% {box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);} 100% {box-shadow: 0 0 0 rgba(255, 215, 0, 0);} }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .case-title { font-size: 1.1rem; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .case-subtitle { font-size: 0.75rem; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }

        .topics-preview { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
        .topic-pill { font-size: 0.7rem; background: #333; color: #ccc; padding: 3px 8px; border-radius: 4px; border: 1px solid #444; }

        .case-mastery { margin-top: 10px; width: 100%; }
        .mastery-label { font-size: 0.7rem; color: var(--text-secondary); display: flex; justify-content: space-between; margin-bottom: 3px; }
        .mastery-bg { width: 100%; height: 4px; background: #111; border-radius: 2px; overflow: hidden; }
        .mastery-fill { height: 100%; width: 0%; background: var(--accent-blue); }
        
        .btn-start-case {
            background: transparent; border: 1px solid var(--accent-blue); color: var(--accent-blue);
            padding: 6px 12px; font-family: var(--font-mono); cursor: pointer; font-size: 0.75rem; text-transform: uppercase; border-radius: 4px;
            margin-left: 10px;
        }
        .btn-start-case:hover { background: var(--accent-blue); color: #fff; }

        /* --- DIFFICULTY SELECTOR --- */
        #difficulty-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(18, 18, 18, 0.98); flex-direction: column; align-items: center; justify-content: center; z-index: 50; padding: 20px;
        }
        .diff-card {
            background: #252525; border: 1px solid var(--border-color); width: 100%; max-width: 400px; padding: 20px; margin-bottom: 15px;
            border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: left;
        }
        .diff-card:hover { transform: scale(1.02); }
        .diff-card.easy:hover { border-color: var(--accent-green); box-shadow: 0 0 15px rgba(0, 230, 118, 0.2); }
        .diff-card.medium:hover { border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(41, 121, 255, 0.2); }
        .diff-card.hard:hover { border-color: var(--accent-red); box-shadow: 0 0 15px rgba(255, 82, 82, 0.2); }
        
        .diff-title { font-family: var(--font-serif); font-size: 1.2rem; color: #fff; margin-bottom: 5px; }
        .diff-desc { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px; }
        .diff-meta { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }

        /* --- GAME SCREEN --- */
        #game-screen { display: none; flex: 1; flex-direction: column; overflow: hidden; position: relative; }

        #chat-window {
            flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth;
        }

        /* CASE FILE */
        .case-file-doc {
            background: var(--paper-bg); color: var(--paper-text); font-family: var(--font-body);
            padding: 25px; border-left: 6px solid #8b0000; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border-radius: 2px; margin-bottom: 20px; position: sticky; top: 0; z-index: 5;
            animation: slideIn 0.5s ease;
        }
        .case-file-doc::before { content: "SACHVERHALT"; position: absolute; top: 10px; right: 10px; font-family: var(--font-mono); font-size: 0.6rem; border: 1px solid #8b0000; color: #8b0000; padding: 2px 5px; transform: rotate(-5deg); opacity: 0.7; }
        .case-file-text { font-size: 0.95rem; line-height: 1.6; }

        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .message {
            max-width: 85%; padding: 15px 20px; border-radius: 4px; animation: fadeIn 0.3s ease-up; line-height: 1.5; position: relative;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.partner {
            align-self: flex-start; background-color: #252525; border-left: 3px solid var(--text-secondary);
            font-family: var(--font-serif); font-size: 1.1rem; color: #fff;
        }
        .message.partner::before { content: "SENIOR PARTNER"; position: absolute; top: -18px; left: 0; font-family: var(--font-mono); font-size: 0.6rem; color: var(--text-secondary); }

        .message.user { align-self: flex-end; background-color: #2a3b4d; border-right: 3px solid var(--accent-blue); text-align: right; font-size: 0.95rem; }

        .message.system { align-self: center; font-size: 0.8rem; padding: 8px 15px; border-radius: 20px; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
        .message.system.success { color: var(--accent-green); border: 1px solid var(--accent-green); background: rgba(0, 230, 118, 0.05); }
        .message.system.fail { color: var(--accent-red); border: 1px solid var(--accent-red); background: rgba(255, 82, 82, 0.05); }
        .message.system.info { color: var(--accent-gold); border: 1px solid var(--accent-gold); background: rgba(255, 215, 0, 0.05); }

        /* --- INPUT AREA --- */
        #input-area {
            padding: 20px; border-top: 1px solid var(--border-color); background: #181818; min-height: 140px; display: flex; flex-direction: column; justify-content: center; gap: 10px;
        }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-option { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-primary); padding: 12px; font-family: var(--font-mono); cursor: pointer; transition: all 0.2s; text-align: left; }
        .btn-option:hover { border-color: var(--accent-blue); background: rgba(41, 121, 255, 0.1); }
        
        .step-label { font-size: 0.8rem; color: var(--accent-gold); font-family: var(--font-mono); margin-bottom: 5px; display: block;}
        
        .text-input-wrapper { display: flex; gap: 10px; flex-direction: column; }
        textarea { 
            flex: 1; background: transparent; border: 1px solid var(--text-secondary); color: #fff; padding: 12px; font-family: var(--font-mono); outline: none; resize: none; min-height: 80px; 
        }
        textarea:focus { border-color: var(--accent-blue); }
        .btn-submit { background: var(--accent-blue); color: #fff; border: none; padding: 12px; cursor: pointer; font-family: var(--font-mono); font-weight: 600; text-transform: uppercase; }
        
        .btn-giveup {
            width: 100%; padding: 10px; background: transparent; border: 1px dashed var(--text-secondary); color: var(--text-secondary);
            font-family: var(--font-mono); cursor: pointer; font-size: 0.8rem; text-transform: uppercase;
        }
        .btn-giveup:hover { border-color: var(--accent-red); color: var(--accent-red); }

        /* Comparison View */
        #comparison-view { display: none; flex-direction: column; gap: 15px; width: 100%; }
        .compare-box { background: #222; border: 1px solid #444; padding: 10px; border-radius: 6px; }
        .compare-label { font-size: 0.7rem; text-transform: uppercase; color: #888; margin-bottom: 5px; }
        .user-text { color: #fff; font-family: var(--font-mono); font-size: 0.9rem; }
        .model-text { color: var(--accent-green); font-family: var(--font-serif); font-size: 1rem; line-height: 1.5; white-space: pre-wrap; }
        
        .assessment-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .btn-assess-ok { flex: 1; background: rgba(0, 230, 118, 0.1); border: 1px solid var(--accent-green); color: var(--accent-green); padding: 15px; cursor: pointer; font-family: var(--font-mono); }
        .btn-assess-no { flex: 1; background: rgba(255, 82, 82, 0.1); border: 1px solid var(--accent-red); color: var(--accent-red); padding: 15px; cursor: pointer; font-family: var(--font-mono); }
        .btn-assess-ok:hover { background: var(--accent-green); color: #000; }
        .btn-assess-no:hover { background: var(--accent-red); color: #000; }

        @media (max-width: 600px) { .options-grid { grid-template-columns: 1fr; } }

        /* --- ARCHIVE & OVERLAYS --- */
        #archive-screen {
            display: none; flex: 1; padding: 20px; overflow-y: auto; flex-direction: column; background: var(--bg-color);
        }
        .archive-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        .archive-list { display: flex; flex-direction: column; gap: 30px; }
        .archive-group h3 { color: var(--accent-blue); border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px; font-family: var(--font-serif); }
        .archive-item { background: #1a1a1a; padding: 20px; border-radius: 6px; border-left: 3px solid var(--text-secondary); margin-bottom: 15px; }
        .archive-q { font-weight: bold; margin-bottom: 10px; color: #fff; font-family: var(--font-serif); font-size: 1.1rem; }
        .archive-sol { font-size: 0.95rem; color: var(--text-primary); white-space: pre-wrap; line-height: 1.6; }
        .exam-grade-input { width: 60px; background: #000; border: 1px solid #555; color: #fff; text-align: center; padding: 5px; margin-left: 10px; }

        #game-over-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(18, 18, 18, 0.98);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .status-text { font-family: var(--font-serif); font-size: 2.5rem; margin-bottom: 10px; text-transform: uppercase; text-align: center; }
        .status-sub { font-size: 1rem; color: #888; margin-bottom: 30px; text-align: center; padding: 0 20px;}
        .btn-back { background: transparent; border: 1px solid #fff; color: #fff; padding: 12px 30px; cursor: pointer; font-family: var(--font-mono); margin-top: 10px; text-transform: uppercase; }
        .btn-back:hover { background: #fff; color: #000; }

        .dev-btn { position: fixed; bottom: 5px; right: 5px; opacity: 0.1; font-size: 0.7rem; cursor: pointer; color: #fff; z-index: 200; border: 1px solid #fff; padding: 2px;}
        .dev-btn:hover { opacity: 1; }
        .reset-trigger { position: fixed; bottom: 5px; left: 5px; opacity: 0.2; font-size: 1.5rem; cursor: pointer; z-index: 200; }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="case-id" id="header-title">KANZLEI-SYSTEM v15.1</div>
            <div class="game-header-elements" id="game-header-elements">
                <div class="trust-container">
                    <span class="trust-label">PARTNER'S TRUST</span>
                    <div class="progress-bg"><div class="progress-fill" id="trust-bar"></div></div>
                </div>
                <button class="btn-exit" onclick="exitToMenu()">‚úï</button>
            </div>
            <div id="timer-container"><div id="timer-bar"></div></div>
        </header>

        <div id="menu-screen">
            <div class="menu-header">
                <div class="menu-title">Aktenbestand</div>
                <div class="menu-subtitle">√ñffentliches Recht - Training Mode</div>
            </div>
            <div class="global-progress-container">
                <div class="global-label"><span>Gesamtzulassung zur Klausur</span><span id="global-pct">0%</span></div>
                <div class="global-bar-bg"><div class="global-bar-fill" id="global-bar"></div></div>
            </div>
            <div class="archive-link"><button class="btn-archive" onclick="showArchive()">üìÇ Aktenarchiv (Volltext)</button></div>
            <div id="case-list"></div>
            <div id="exam-card" class="case-card exam-card">
                <div style="font-size: 2rem;">üîí</div>
                <div class="case-title" style="margin-top: 10px; color: #666;">ABSCHLUSSKLAUSUR</div>
                <div class="case-subtitle" style="color: #444;">Freigabe bei 100% Gesamtzulassung</div>
            </div>
        </div>

        <div id="difficulty-screen">
            <div class="menu-title" style="margin-bottom: 30px;">W√§hlen Sie Ihre Position</div>
            <div class="diff-card easy" onclick="selectDifficulty('easy')">
                <div class="diff-title">Junior Associate (Leicht)</div>
                <div class="diff-desc">Multiple Choice (Gef√ºhrt). Schritt f√ºr Schritt.</div>
                <div class="diff-meta">Zeit: 90s | Risiko: Gering</div>
            </div>
            <div class="diff-card medium" onclick="selectDifficulty('medium')">
                <div class="diff-title">Associate (Mittel)</div>
                <div class="diff-desc">Gef√ºhrte Texteingabe. Sie erhalten Hinweise.</div>
                <div class="diff-meta">Zeit: 60s | Risiko: Mittel</div>
            </div>
            <div class="diff-card hard" onclick="selectDifficulty('hard')">
                <div class="diff-title">Partner (Schwer)</div>
                <div class="diff-desc">Freies Gutachten. Ein Textfeld, keine Hilfe.</div>
                <div class="diff-meta">Zeit: 45s | Risiko: Hoch</div>
            </div>
            <button class="btn-back" style="margin-top:20px; font-size: 0.8rem;" onclick="exitToMenu()">Abbrechen</button>
        </div>

        <div id="archive-screen">
            <div class="archive-header">
                <div class="menu-title" style="font-size: 1.2rem;" id="archive-title">Musterl√∂sungen</div>
                <button class="btn-back" style="margin:0; padding: 5px 15px; font-size: 0.8rem;" onclick="exitToMenu()">Zur√ºck</button>
            </div>
            <div id="archive-content" class="archive-list"></div>
            <div id="exam-result-footer" style="display:none; padding: 20px; text-align: center; border-top: 1px solid #333; margin-top: 20px;">
                <button class="btn-assess-ok" onclick="calculateGrade()">NOTENBERECHNUNG ABSCHLIE√üEN</button>
            </div>
        </div>

        <div id="game-screen">
            <div id="chat-window"></div>
            <div id="input-area"></div>
        </div>

        <div id="game-over-screen">
            <div class="status-text" id="overlay-title">STATUS</div>
            <div class="status-sub" id="overlay-msg"></div>
            <button class="btn-back" onclick="exitToMenu()">Zur√ºck zur √úbersicht</button>
        </div>
        
        <div class="reset-trigger" onclick="hardReset()" title="Reset">üóëÔ∏è</div>
        <div class="dev-btn" onclick="devUnlock()">[DEV: Unlock]</div>
    </div>

    <script>
        // --- CONTENT DATABASE ---
        const cases = [
            // STANDARD TASKS (1-5)
            {
                id: "AKTE_001", complexity: 'standard',
                title: "Grundlagen & Methoden", subtitle: "Aufgaben 1, 2, 5",
                topics: ["Systematische Auslegung", "Historische Auslegung", "Verfassungskonforme Auslegung", "Richtlinienkonforme Auslegung"],
                questions: [
                    { id: 1, points: 1, type: 'choice', intro: "Ein Gesetz ist unklar. Wir ermitteln den Inhalt anhand der Stellung im Gesetz. Welche Auslegung?", options: ["Historische Auslegung", "Systematische Auslegung", "Teleologische Auslegung"], correctAnswer: 1, feedback: "Korrekt.", explanation: "Systematische Auslegung pr√ºft die Stellung im Gesetz." },
                    { id: 2, points: 1, type: 'text', intro: "Was versteht man unter 'Historischer Auslegung'?", explanation: "Ermittlung des Willens des historischen Gesetzgebers anhand der Entstehungsgeschichte (Gesetzesmaterialien, Protokolle)." },
                    { id: 3, points: 1, type: 'choice', intro: "Ein Gesetz verst√∂√üt scheinbar gegen das GG. Was besagt die 'verfassungskonforme Auslegung'?", options: ["Gesetz ist nichtig.", "Diejenige Deutung w√§hlen, die mit dem GG vereinbar ist.", "BVerfG fragen."], correctAnswer: 1, feedback: "Exakt.", explanation: "Die Norm bleibt g√ºltig." },
                    { id: 5, points: 1, type: 'text', intro: "Wo werden vom Bundespr√§sidenten ausgefertigte Gesetze ver√∂ffentlicht?", explanation: "Im Bundesgesetzblatt." }
                ],
                detailed_solution: `Aufgabe 1: Systematische Auslegung ist das Feststellen des normativen Aussagegehaltes einer Norm anhand ihrer Stellung im Gesetz oder im Gesamtzusammenhang der Rechtsordnung.\nAufgabe 2: Verfassungskonforme Auslegung bedeutet, dass wenn ein Gesetz mehrere Deutungen zul√§sst, diejenige zu w√§hlen ist, die mit dem Grundgesetz vereinbar ist.`
            },
            {
                id: "AKTE_002", complexity: 'standard',
                title: "Staatsorganisation", subtitle: "Aufgaben 3, 4, 11 + Zusatz",
                topics: ["Staatsziele", "Anstalt vs. K√∂rperschaft", "Stiftung", "Demokratieprinzip", "Rechtsstaatsprinzip", "Bundesstaatsprinzip"],
                questions: [
                    { id: 3, points: 1, type: 'text', intro: "Was ist eine Staatszielbestimmung? (Def + Bsp)", explanation: "Verfassungsnorm, die dem Staat Aufgaben vorgibt, ohne subjektive Rechte f√ºr den Einzelnen zu begr√ºnden (Bsp: Sozialstaat, Umweltschutz)." },
                    { id: 4, points: 1, type: 'text', intro: "Definieren Sie 'Anstalt des √∂ffentlichen Rechts'.", explanation: "Zusammenfassung von Personal- und Sachmitteln zur Erf√ºllung einer √∂ffentlichen Aufgabe, die Benutzern zur Verf√ºgung steht." },
                    { id: 4, points: 1, type: 'choice', intro: "Unterschied zur K√∂rperschaft?", options: ["K√∂rperschaft ist privat.", "K√∂rperschaft ist mitgliedschaftlich organisiert.", "Kein Unterschied."], correctAnswer: 1, feedback: "Richtig.", explanation: "K√∂rperschaft = Mitglieder. Anstalt = Benutzer." },
                    { id: 11, points: 2, type: 'text', intro: "Nennen Sie ein Beispiel im GG f√ºr das Demokratieprinzip.", explanation: "Art. 20 Abs. 1 und 2 GG (Wahlen / Volkssouver√§nit√§t)." },
                    { id: 21, points: 2, type: 'text', intro: "Was fordert das Rechtsstaatsprinzip? Nennen Sie ein Kernelement.", explanation: "Gewaltenteilung, Gesetzm√§√üigkeit der Verwaltung (Vorrang/Vorbehalt), Verh√§ltnism√§√üigkeit, Rechtssicherheit." },
                    { id: 22, points: 2, type: 'text', intro: "Definieren Sie das Bundesstaatsprinzip.", explanation: "Aufteilung der staatlichen Aufgaben zwischen dem Gesamtstaat (Bund) und den Gliedstaaten (L√§ndern)." }
                ],
                detailed_solution: `Aufgabe 3: Staatszielbestimmung ist eine Verfassungsnorm, die dem Staat Aufgaben vorgibt, ohne subjektive Rechte f√ºr den Einzelnen zu begr√ºnden (Bsp: Sozialstaat).\nAufgabe 4: Anstalt ist eine Zusammenfassung von Personal- und Sachmitteln zur Erf√ºllung einer √∂ffentlichen Aufgabe f√ºr Benutzer. Eine K√∂rperschaft ist mitgliedschaftlich organisiert.\nAufgabe 11+: Staatsstrukturprinzipien (Art. 20 GG) umfassen Demokratie, Rechtsstaat (Gewaltenteilung, Rechtssicherheit), Bundesstaat (F√∂deralismus) und Sozialstaat.`
            },
            // COMPLEX: NOSSEN (Task 6 - MULTI STEP)
            {
                id: "AKTE_003", complexity: 'high',
                title: "Fall: Nossen vs. Ketzerbachtal", subtitle: "Aufgabe 6 (Rechtsweg)",
                topics: ["Rechtsweger√∂ffnung", "Abgrenzungstheorien", "S√§chsKomZG"],
                case_context: "Die s√§chsische Stadt Nossen und die Gemeinde Ketzerbachtal bilden eine Verwaltungsgemeinschaft nach dem S√§chsKomZG. Ketzerbachtal will Nossen auf Schadensersatz verklagen, weil Aufgaben angeblich nicht richtig wahrgenommen wurden.",
                // Multi Step Logic
                steps: [
                    {
                        step_title: "1. Rechtsweger√∂ffnung",
                        question: "Welcher Rechtsweg ist er√∂ffnet?",
                        article_hint: "¬ß 40 VwGO",
                        mode_easy_options: ["Ordentlicher Rechtsweg (BGB)", "Verwaltungsrechtsweg (¬ß 40 VwGO)", "Verfassungsgericht"],
                        correct_option_index: 1,
                        mode_medium_hint: "Pr√ºfen Sie ¬ß 40 VwGO. Um welche Art Streitigkeit handelt es sich?"
                    },
                    {
                        step_title: "2. Abgrenzungstheorien",
                        question: "Welche Theorien ziehen Sie zur Abgrenzung heran?",
                        article_hint: "Theorienstreit",
                        mode_easy_options: ["Zwei-Reiche-Lehre", "Subordinationstheorie, Interessentheorie, Mod. Subjektstheorie", "Schutznormtheorie"],
                        correct_option_index: 1,
                        mode_medium_hint: "Nennen Sie die drei g√§ngigen Theorien zur Abgrenzung √ñffentliches Recht/Privatrecht."
                    },
                    {
                        step_title: "3. Subsumtion",
                        question: "Warum ist es hier √∂ffentlich-rechtlich?",
                        article_hint: "S√§chsKomZG",
                        mode_easy_options: ["Weil es um Geld geht.", "Privatrechtlich, da Vertrag.", "√ñffentlich-rechtlich, da S√§chsKomZG Hoheitstr√§ger als solche berechtigt (Sonderrecht)."],
                        correct_option_index: 2,
                        mode_medium_hint: "Wenden Sie die Sonderrechtstheorie auf das S√§chsKomZG an."
                    }
                ],
                // Fallback for Exam mode (flat question)
                questions: [ {id: 6, points: 5, intro: "Pr√ºfen Sie die Rechtsweger√∂ffnung umfassend.", explanation: "..."} ], 
                detailed_solution: `Aufgabe 6 L√∂sung:
1. Obersatz: Der Rechtsweg zu den Verwaltungsgerichten ist gem. ¬ß 40 Abs. 1 VwGO er√∂ffnet, wenn es sich um eine √∂ffentlich-rechtliche Streitigkeit nichtverfassungsrechtlicher Art handelt.
2. Abgrenzungstheorien:
a) Subordinationstheorie: √úber-/Unterordnungsverh√§ltnis? (Hier (-)).
b) Interessentheorie: √ñffentliches Interesse? (Ja).
c) Modifizierte Subjektstheorie: Berechtigt die Norm einen Hoheitstr√§ger gerade als solchen? (Sonderrecht).
3. Subsumtion: Das S√§chsKomZG berechtigt und verpflichtet ausschlie√ülich Gemeinden (Hoheitstr√§ger). Damit liegt Sonderrecht des Staates vor -> √ñffentlich-rechtliche Streitigkeit. ¬ß 40 VwGO (+).`
            },
            // COMPLEX: WINDKRAFT (Task 7)
            {
                id: "AKTE_004", complexity: 'high',
                title: "Fall: Windkraft (F√∂rster)", subtitle: "Aufgabe 7 (Zul√§ssigkeit)",
                topics: ["Anfechtungsklage", "Klagebefugnis", "Art. 14 GG", "Gemeinde-Klagerecht"],
                case_context: "August F√∂rster betreibt ein Hotel im Au√üenbereich. In 1000m Entfernung wird eine Windkraftanlage genehmigt. Er f√ºrchtet L√§rm und Aussichtsverlust und will klagen. Auch die Stadt L√∂bau ist dagegen.",
                steps: [
                    {
                        step_title: "1. Statthafte Klageart",
                        question: "Was ist die statthafte Klageart?",
                        article_hint: "Begehren: Aufhebung",
                        mode_easy_options: ["Verpflichtungsklage", "Anfechtungsklage (¬ß 42 I VwGO)", "Feststellungsklage"],
                        correct_option_index: 1,
                        mode_medium_hint: "Der Kl√§ger will die Aufhebung eines VA. Welche Klageart passt?"
                    },
                    {
                        step_title: "2. Klagebefugnis (F√∂rster)",
                        question: "Was muss F√∂rster geltend machen?",
                        article_hint: "¬ß 42 II VwGO",
                        mode_easy_options: ["Tats√§chliche Verletzung", "M√∂glichkeit einer Rechtsverletzung (Art. 14 GG)", "Beliebiges Interesse"],
                        correct_option_index: 1,
                        mode_medium_hint: "Welche Theorie gilt f√ºr ¬ß 42 II VwGO? Welches Grundrecht ist betroffen?"
                    },
                    {
                        step_title: "3. Klagebefugnis (Gemeinde)",
                        question: "Worauf kann sich die Gemeinde berufen?",
                        article_hint: "Art. 28 GG",
                        mode_easy_options: ["Grundrechte", "Eigentum", "Kommunale Selbstverwaltungsgarantie (Planungshoheit)"],
                        correct_option_index: 2,
                        mode_medium_hint: "K√∂nnen Gemeinden Grundrechte haben? Nein. Worauf st√ºtzen sie sich?"
                    }
                ],
                questions: [ {id: 7, points: 6, intro: "Pr√ºfen Sie die Zul√§ssigkeit.", explanation: "..."} ],
                detailed_solution: `Aufgabe 7 L√∂sung:
A. Zul√§ssigkeit der Klage des Hoteliers F√∂rster:
1. Statthafte Klageart: Anfechtungsklage (¬ß 42 I VwGO), da Aufhebung eines VA (¬ß 35 VwVfG) begehrt.
2. Klagebefugnis: M√∂glichkeit einer Verletzung in eigenen subjektiven Rechten (M√∂glichkeitstheorie). Hier: Art. 14 GG (Eigentum am Gewerbebetrieb).
3. Vorverfahren: Widerspruch (¬ß 68 VwGO).
B. Klage der Stadt L√∂bau:
Gemeinden haben keine Grundrechte (Konfusionsargument). Sie m√ºssen sich auf Art. 28 Abs. 2 GG (Kommunale Selbstverwaltung / Planungshoheit) berufen.`
            },
            // STANDARD TASKS
            {
                id: "AKTE_005", complexity: 'standard',
                title: "Normen & Verfassung", subtitle: "Aufgaben 8, 9, 10, 12",
                topics: ["Normarten (TKG)", "Art. 13 GG", "Grundrechte Staat", "Rundfunkfreiheit", "Gesetzgebungskompetenz"],
                questions: [
                    { id: 8, points: 3, type: 'choice', intro: "¬ß 87 I TKG gibt ein Ziel vor. Normart?", options: ["Konditional", "Final", "Deskriptiv"], correctAnswer: 1, feedback: "Final = Ziel.", explanation: "Final gefasste Norm." },
                    { id: 8, points: 3, type: 'choice', intro: "¬ß 110 I TKG (Wenn-Dann)?", options: ["Konditional", "Final", "Deskriptiv"], correctAnswer: 0, feedback: "Korrekt.", explanation: "Konditional gefasste Norm." },
                    { id: 9, points: 2, type: 'text', intro: "Art. 13 GG. Sind Gesch√§ftsr√§ume gesch√ºtzt?", explanation: "Ja. Aber w√§hrend √ñffnungszeiten geringerer Schutz." },
                    { id: 10, points: 7, type: 'text', intro: "ZDF-Fall. Kann sich der Staat auf Grundrechte berufen?", explanation: "Grundsatz: Nein (Konfusionsargument). Ausnahme: Rundfunkfreiheit (Art. 5 I 2 GG)." },
                    { id: 12, points: 1, type: 'choice', intro: "Corona-Notbremse Kompetenz?", options: ["L√§nder", "Bund", "EU"], correctAnswer: 1, feedback: "Richtig.", explanation: "Bund. Art. 74 GG." }
                ],
                detailed_solution: `Aufgabe 8: a) ¬ß 87 TKG: Final. b) ¬ß 110 TKG: Konditional. c) ¬ß 3 TKG: Deskriptiv.\nAufgabe 9: Gesch√§ftsr√§ume fallen unter 'Wohnung' (Art. 13 GG). W√§hrend √ñffnungszeiten geringerer Schutz.\nAufgabe 10: Grundsatz: Staat kann sich nicht auf Grundrechte berufen (Konfusionsargument). Ausnahme: Rundfunkfreiheit. Gremien: Gebot der Vielfaltsicherung und Staatsferne (Drittel-Quote).`
            },
            {
                id: "AKTE_006", complexity: 'standard',
                title: "Verwaltung & Europa", subtitle: "Aufgaben 13-19",
                topics: ["EU-Grundfreiheiten", "Amtshaftung", "VA-Definition", "Ermessen", "Widerruf", "EU-Grundrechte"],
                questions: [
                    { id: 13, points: 2, type: 'text', intro: "Nennen Sie zwei EU-Grundfreiheiten.", explanation: "Warenverkehr, Arbeitnehmerfreiz√ºgigkeit, Dienstleistung, Niederlassung." },
                    { id: 14, points: 2, type: 'choice', intro: "Amtshaftung Anspruchsgrundlage?", options: ["¬ß 823 BGB", "¬ß 839 BGB i.V.m. Art. 34 GG", "VwGO"], correctAnswer: 1, feedback: "Richtig.", explanation: "¬ß 839 BGB + Art. 34 GG." },
                    { id: 15, points: 3, type: 'text', intro: "Definition Verwaltungsakt (¬ß 35 VwVfG).", explanation: "Hoheitliche Ma√ünahme einer Beh√∂rde auf Gebiet des √∂ff. Rechts zur Regelung eines Einzelfalls mit Au√üenwirkung." },
                    { id: 16, points: 1, type: 'text', intro: "Nennen Sie einen Ermessensfehler.", explanation: "Ermessensnichtgebrauch, Ermessens√ºberschreitung, Ermessensfehlgebrauch." },
                    { id: 17, points: 2, type: 'text', intro: "Norm f√ºr Widerruf?", explanation: "¬ß 49 VwVfG." }
                ],
                detailed_solution: `Aufgabe 14: Amtshaftung: ¬ß 839 I BGB i.V.m. Art. 34 GG.\nAufgabe 15: VA = Hoheitliche Ma√ünahme einer Beh√∂rde auf dem Gebiet des √∂ff. Rechts zur Regelung eines Einzelfalls mit Au√üenwirkung (¬ß 35 VwVfG).\nAufgabe 17: Widerruf geregelt in ¬ß 49 VwVfG.`
            },
            // COMPLEX: BUS (Task 20)
            {
                id: "AKTE_007", complexity: 'high',
                title: "Fall: Busunternehmer", subtitle: "Aufgabe 20 (Gewerbe)",
                topics: ["Spezialgesetz PBefG", "Unzuverl√§ssigkeit", "Widerruf"],
                case_context: "Ein Busunternehmer hat erhebliche Steuerschulden und zahlt keine Sozialabgaben mehr. Das Landratsamt m√∂chte ihm die Genehmigung entziehen.",
                steps: [
                    {
                        step_title: "1. Rechtsgrundlage",
                        question: "Was ist die Rechtsgrundlage f√ºr den Entzug?",
                        article_hint: "Spezialgesetz vor GewO!",
                        mode_easy_options: ["¬ß 35 GewO", "¬ß 25 PBefG", "¬ß 48 VwVfG"],
                        correct_option_index: 1,
                        mode_medium_hint: "Nennen Sie das Spezialgesetz f√ºr Busunternehmer (Personenbef√∂rderung)."
                    },
                    {
                        step_title: "2. Tatbestandsvoraussetzungen",
                        question: "Was muss vorliegen?",
                        article_hint: "¬ß 25 PBefG",
                        mode_easy_options: ["Nur Schulden", "Wegfall der Voraussetzungen + Unzuverl√§ssigkeit", "Ermessen der Beh√∂rde"],
                        correct_option_index: 1,
                        mode_medium_hint: "Nennen Sie die zwei zentralen Voraussetzungen."
                    },
                    {
                        step_title: "3. Definition",
                        question: "Definieren Sie 'Unzuverl√§ssigkeit'.",
                        article_hint: "Prognoseentscheidung",
                        mode_easy_options: ["Hat Schulden", "Bietet keine Gew√§hr f√ºr k√ºnftigen ordnungsgem√§√üen Betrieb", "Ist vorbestraft"],
                        correct_option_index: 1,
                        mode_medium_hint: "Formulieren Sie die Definition der 'Unzuverl√§ssigkeit' (Prognose)."
                    }
                ],
                questions: [ {id: 20, points: 5, intro: "Pr√ºfen Sie die Rechtm√§√üigkeit.", explanation: "..."} ],
                detailed_solution: `Aufgabe 20 L√∂sung:\n1. Rechtsgrundlage: Spezialgesetz Personenbef√∂rderungsgesetz (PBefG), nicht GewO! Ma√ünahme: Widerruf der Genehmigung gem√§√ü ¬ß 25 Abs. 1 PBefG.\n2. Tatbestandsvoraussetzungen:\n- Wegfall der Genehmigungsvoraussetzungen.\n- Konkrete Tatsachen (z.B. Steuerschulden).\n- Unzuverl√§ssigkeit: Gewerbetreibender bietet nach Gesamteindruck nicht die Gew√§hr f√ºr k√ºnftigen ordnungsgem√§√üen Betrieb (Negative Zukunftsprognose).`
            }
        ];

        // --- ENGINE ---
        let activeCase = null;
        let trust = 50;
        let savedProgress = {};
        let questionQueue = [];
        let timerInterval = null;
        let timeLeft = 60;
        let currentDifficulty = 'standard';
        let isExamMode = false;
        let examAnswers = [];
        let stepIndex = 0; // Tracks multi-step cases

        try {
            const data = localStorage.getItem('junior_lawyer_save_v15_1');
            if (data) savedProgress = JSON.parse(data);
        } catch (e) {
            console.log("Reset.");
            savedProgress = {};
        }

        const menuScreen = document.getElementById('menu-screen');
        const diffScreen = document.getElementById('difficulty-screen');
        const gameScreen = document.getElementById('game-screen');
        const archiveScreen = document.getElementById('archive-screen');
        const caseList = document.getElementById('case-list');
        const archiveContent = document.getElementById('archive-content');
        const gameHeader = document.getElementById('game-header-elements');
        const chatWindow = document.getElementById('chat-window');
        const inputArea = document.getElementById('input-area');
        const overlay = document.getElementById('game-over-screen');
        const globalBar = document.getElementById('global-bar');
        const globalPct = document.getElementById('global-pct');
        const examCardDiv = document.getElementById('exam-card');
        const archiveTitle = document.getElementById('archive-title');
        const examResultFooter = document.getElementById('exam-result-footer');

        function init() { renderMenu(); }

        // --- MENU ---
        function renderMenu() {
            caseList.innerHTML = '';
            let totalCases = cases.length;
            let completedCases = 0;

            cases.forEach((c, idx) => {
                let highScore = savedProgress[c.id] || 0;
                if(highScore >= 100) completedCases++;
                let barW = highScore + "%";
                let barC = highScore >= 100 ? 'var(--accent-green)' : (highScore > 0 ? 'var(--accent-blue)' : '#333');
                let topics = c.topics.map(t => `<span class="topic-pill">${t}</span>`).join('');
                let isComplex = c.complexity === 'high';

                const card = document.createElement('div');
                card.className = `case-card ${isComplex ? 'complex' : ''}`;
                if(highScore >= 100) card.classList.add('completed');
                card.onclick = (e) => { if(!e.target.classList.contains('btn-start-case')) prepareCase(idx); };
                
                card.innerHTML = `
                    <div class="card-top">
                        <div style="flex:1">
                            <div class="case-title">${c.title}</div>
                            <div class="case-subtitle">${c.subtitle} ${isComplex ? '‚òÖ' : ''}</div>
                        </div>
                        <button class="btn-start-case" onclick="event.stopPropagation(); prepareCase(${idx})">Start</button>
                    </div>
                    <div class="topics-preview">${topics}</div>
                    <div class="case-mastery">
                        <div class="mastery-label"><span>Status:</span><span>${highScore >= 100 ? 'Abgeschlossen' : highScore + '%'}</span></div>
                        <div class="mastery-bg"><div class="mastery-fill" style="width:${barW}; background:${barC}"></div></div>
                    </div>
                `;
                caseList.appendChild(card);
            });

            let globalPerc = Math.round((completedCases / totalCases) * 100);
            globalBar.style.width = globalPerc + "%";
            globalPct.innerText = globalPerc + "%";

            examCardDiv.innerHTML = '';
            if (globalPerc >= 100) {
                examCardDiv.classList.add('unlocked');
                examCardDiv.onclick = startExam;
                examCardDiv.innerHTML = `<div style="font-size: 2rem;">üìú</div><div class="case-title" style="margin-top: 10px; color: var(--accent-gold);">KLAUSUR STARTEN</div><div class="case-subtitle" style="color: #fff;">Pr√ºfungssimulation: Alle Akten</div>`;
            } else {
                examCardDiv.classList.remove('unlocked');
                examCardDiv.onclick = null;
                examCardDiv.innerHTML = `<div style="font-size: 2rem;">üîí</div><div class="case-title" style="margin-top: 10px; color: #666;">ABSCHLUSSKLAUSUR</div><div class="case-subtitle" style="color: #444;">Freigabe bei 100% Gesamtzulassung</div>`;
            }
        }

        // --- PREP ---
        let selectedCaseIdx = -1;

        function prepareCase(idx) {
            selectedCaseIdx = idx;
            const c = cases[idx];
            if (c.complexity === 'high') {
                menuScreen.style.display = 'none';
                diffScreen.style.display = 'flex';
            } else {
                startStandard(idx);
            }
        }

        function selectDifficulty(diff) {
            diffScreen.style.display = 'none';
            startComplex(selectedCaseIdx, diff);
        }

        function startStandard(idx) {
            currentDifficulty = 'standard';
            activeCase = cases[idx];
            questionQueue = activeCase.questions.map((q, i) => ({...q, index: i}));
            launchGame();
        }

        function startComplex(idx, diff) {
            currentDifficulty = diff;
            activeCase = cases[idx];
            stepIndex = 0;
            // HARD MODE = Single Question (Free Recall)
            if (diff === 'hard') {
                questionQueue = [{
                    type: 'text', 
                    intro: "Erstellen Sie ein umfassendes Gutachten zur Rechtslage.", 
                    explanation: activeCase.detailed_solution,
                    isHardMode: true
                }];
            } else {
                // EASY/MEDIUM = Loop through steps
                // We create a dummy queue of indexes [0, 1, 2...] based on steps length
                questionQueue = activeCase.steps.map((s, i) => ({ stepIdx: i }));
            }
            launchGame();
        }

        function launchGame() {
            trust = 50;
            isExamMode = false;
            menuScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            gameHeader.style.display = 'flex';
            document.getElementById('timer-container').style.display = 'block';
            updateTrust();
            chatWindow.innerHTML = '';
            addMsg('system', 'AKTE GELADEN: ' + activeCase.title, 'info');
            
            // SHOW CASE FILE IF COMPLEX
            if (activeCase.complexity === 'high') {
                const doc = document.createElement('div');
                doc.className = 'case-file-doc';
                doc.innerHTML = `<div class="case-file-text">${activeCase.case_context}</div>`;
                chatWindow.appendChild(doc);
            }

            setTimeout(nextQ, 800);
        }

        // --- QUEUE LOGIC ---
        function nextQ() {
            if (questionQueue.length === 0) return endCase(true);
            
            // Complex (Easy/Medium) vs Standard Logic
            let item = questionQueue[0];
            
            if (activeCase.complexity === 'high' && currentDifficulty !== 'hard') {
                // Multi-Step Logic
                let step = activeCase.steps[item.stepIdx];
                addMsg('partner', `${step.step_title}: ${step.question}`);
                renderMultiStepInput(step);
            } else {
                // Standard or Hard Mode
                addMsg('partner', item.intro || "Ihre Aufgabe:");
                renderInput(item);
            }
            startTimer();
        }

        function renderMultiStepInput(step) {
            inputArea.innerHTML = '';
            
            if (currentDifficulty === 'easy') {
                // Easy: MC Buttons
                addMsg('system', `Hinweis: ${step.article_hint}`, 'info');
                const grid = document.createElement('div');
                grid.className = 'options-grid';
                step.mode_easy_options.forEach((opt, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-option';
                    btn.innerText = opt;
                    btn.onclick = () => {
                        stopTimer();
                        addMsg('user', opt);
                        if (i === step.correct_option_index) handleQueue(true);
                        else { addMsg('system', 'Falsch.', 'fail'); handleQueue(false); }
                    };
                    grid.appendChild(btn);
                });
                inputArea.appendChild(grid);

            } else {
                // Medium: Text Input with Hint
                addMsg('system', step.mode_medium_hint, 'info');
                const wrp = document.createElement('div');
                wrp.className = 'text-input-wrapper';
                const inp = document.createElement('textarea');
                inp.placeholder = 'Ihre L√∂sung...';
                const btn = document.createElement('button');
                btn.className = 'btn-submit';
                btn.innerText = 'L√∂sung abgleichen';
                btn.onclick = () => { stopTimer(); showStepComparison(inp.value, step); };
                wrp.appendChild(inp);
                wrp.appendChild(btn);
                inputArea.appendChild(wrp);
            }
        }

        function renderInput(q) {
            inputArea.innerHTML = '';
            
            if (q.type === 'choice') {
                const grid = document.createElement('div');
                grid.className = 'options-grid';
                q.options.forEach((opt, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-option';
                    btn.innerText = "> " + opt;
                    btn.onclick = () => {
                        stopTimer();
                        addMsg('user', opt);
                        if (i === q.correctAnswer) handleQueue(true);
                        else { addMsg('system', 'Falsch.', 'fail'); handleQueue(false); }
                    };
                    grid.appendChild(btn);
                });
                inputArea.appendChild(grid);
            } else {
                // Text / Hard Mode
                const wrp = document.createElement('div');
                wrp.className = 'text-input-wrapper';
                const inp = document.createElement('textarea');
                inp.placeholder = 'Antwort...';
                const btn = document.createElement('button');
                btn.className = 'btn-submit';
                btn.innerText = 'L√∂sung abgleichen';
                btn.onclick = () => { stopTimer(); showStandardComparison(inp.value, q); };
                wrp.append(inp, btn);
                inputArea.appendChild(wrp);
            }
        }

        // --- COMPARISONS ---
        function showStandardComparison(userAns, q) {
            inputArea.innerHTML = '';
            const container = document.createElement('div');
            container.id = 'comparison-view';
            container.innerHTML = `
                <div class="compare-box"><div class="compare-label">Ihre Eingabe</div><div class="user-text">${userAns}</div></div>
                <div class="compare-box" style="border-color:var(--accent-green)"><div class="compare-label" style="color:var(--accent-green)">L√∂sung</div><div class="model-text">${q.explanation}</div></div>
                <div class="assessment-buttons">
                    <button class="btn-assess-no" onclick="handleQueue(false)">Unvollst√§ndig</button>
                    <button class="btn-assess-ok" onclick="handleQueue(true)">Korrekt</button>
                </div>`;
            inputArea.appendChild(container);
            document.getElementById('comparison-view').style.display = 'flex';
        }

        function showStepComparison(userAns, step) {
            // For Medium Steps: We don't have exact solution text in data, so we show the "easy" correct option as solution
            let correctTxt = step.mode_easy_options[step.correct_option_index];
            inputArea.innerHTML = '';
            const container = document.createElement('div');
            container.id = 'comparison-view';
            container.innerHTML = `
                <div class="compare-box"><div class="compare-label">Ihre Eingabe</div><div class="user-text">${userAns}</div></div>
                <div class="compare-box" style="border-color:var(--accent-green)"><div class="compare-label" style="color:var(--accent-green)">L√∂sung</div><div class="model-text">${correctTxt}</div></div>
                <div class="assessment-buttons">
                    <button class="btn-assess-no" onclick="handleQueue(false)">Unvollst√§ndig</button>
                    <button class="btn-assess-ok" onclick="handleQueue(true)">Korrekt</button>
                </div>`;
            inputArea.appendChild(container);
            document.getElementById('comparison-view').style.display = 'flex';
        }

        // --- SMART LOOP ---
        function handleQueue(success) {
            inputArea.innerHTML = '';
            if (success) {
                questionQueue.shift();
                trust = Math.min(100, trust + 5);
                addMsg('system', 'STATUS: KORREKT', 'success');
            } else {
                let failed = questionQueue.shift();
                questionQueue.push(failed);
                trust = Math.max(0, trust - 5);
                addMsg('system', 'WIEDERVORLAGE: Frage hinten angestellt.', 'fail');
            }
            updateTrust();
            setTimeout(nextQ, 1000);
        }

        // --- EXAM MODE ---
        function startExam() {
            isExamMode = true;
            menuScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            gameHeader.style.display = 'none'; 
            document.getElementById('timer-container').style.display = 'none';
            
            questionQueue = []; // Re-use queue variable for exam questions
            examAnswers = [];
            cases.forEach(c => {
                if(c.complexity === 'high') {
                    // One big exam question for complex cases
                    questionQueue.push({
                        intro: c.title + ": " + c.case_context, 
                        explanation: c.detailed_solution, 
                        points: 5 
                    });
                } else {
                    questionQueue.push(...c.questions);
                }
            });

            qIndex = 0; // Use qIndex for exam linear flow
            chatWindow.innerHTML = '';
            addMsg('system', 'ABSCHLUSSKLAUSUR GESTARTET', 'info');
            setTimeout(nextExamQ, 1000);
        }

        function nextExamQ() {
            if (qIndex >= questionQueue.length) { startExamGrading(); return; }
            const q = questionQueue[qIndex];
            addMsg('partner', `Aufgabe ${qIndex+1}: ${q.intro}`);
            
            inputArea.innerHTML = '';
            const wrp = document.createElement('div');
            wrp.className = 'text-input-wrapper';
            const inp = document.createElement('textarea');
            inp.placeholder = 'Klausurl√∂sung...';
            const btn = document.createElement('button');
            btn.className = 'btn-submit';
            btn.innerText = 'N√ÑCHSTE AUFGABE';
            btn.onclick = () => {
                examAnswers.push({ q: q, userAns: inp.value });
                qIndex++;
                nextExamQ();
            };
            wrp.append(inp, btn);
            inputArea.appendChild(wrp);
            setTimeout(() => inp.focus(), 100);
        }

        function startExamGrading() {
            gameScreen.style.display = 'none';
            archiveScreen.style.display = 'flex';
            archiveContent.innerHTML = '';
            document.getElementById('archive-title').innerText = "KORREKTURPHASE";
            examResultFooter.style.display = 'block';
            document.querySelector('#archive-screen .btn-back').style.display = 'none';

            examAnswers.forEach((item, i) => {
                const q = item.q;
                const pts = q.points || 1;
                const div = document.createElement('div');
                div.className = 'archive-item';
                div.innerHTML = `
                    <div class="archive-q">Aufgabe ${i+1} (${pts} Pkt)</div>
                    <div style="display:flex; gap:20px; flex-wrap:wrap;">
                        <div style="flex:1;"><div style="color:#888; font-size:0.7rem">IHRE ANTWORT</div><div class="user-text" style="white-space:pre-wrap; border:1px solid #444; padding:10px;">${item.userAns || '-'}</div></div>
                        <div style="flex:1;"><div style="color:var(--accent-green); font-size:0.7rem">MUSTERL√ñSUNG</div><div class="model-text">${q.explanation}</div></div>
                    </div>
                    <div style="margin-top:15px; text-align:right;"><label>Punkte:</label><input type="number" class="exam-grade-input" id="grade-${i}" min="0" max="${pts}" value="0"> / ${pts}</div>`;
                archiveContent.appendChild(div);
            });
        }

        function calculateGrade() {
            let totalScore = 0;
            let maxScore = 0;
            examAnswers.forEach((item, i) => {
                totalScore += (parseInt(document.getElementById(`grade-${i}`).value) || 0);
                maxScore += (item.q.points || 1);
            });
            let pct = (totalScore / maxScore) * 100;
            let note = pct < 50 ? "Mangelhaft" : (pct < 65 ? "Ausreichend" : (pct < 81 ? "Befriedigend" : (pct < 91 ? "Vollbefriedigend" : "Gut/Sehr Gut")));
            let color = pct < 50 ? "var(--accent-red)" : (pct > 90 ? "var(--accent-gold)" : "var(--accent-green)");
            
            archiveContent.innerHTML = `<div style="text-align:center; padding:50px;"><h1 style="color:${color}; font-size:3rem; margin-bottom:10px;">${note}</h1><p style="color:#aaa;">Punkte: ${totalScore} / ${maxScore} (${Math.round(pct)}%)</p><button class="btn-assess-ok" style="margin-top:30px;" onclick="exitToMenu()">ZUR√úCK</button></div>`;
            examResultFooter.style.display = 'none';
            document.querySelector('#archive-screen .btn-back').style.display = 'block';
        }

        // --- COMMON ---
        function startTimer() {
            timeLeft = 60; // 60s Default
            document.getElementById('timer-bar').style.width = '100%';
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-bar').style.width = (timeLeft/60)*100 + "%";
                if (timeLeft <= 0) { clearInterval(timerInterval); handleQueue(false); }
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInterval); }

        function endCase(win) {
            stopTimer();
            overlay.style.display = 'flex';
            document.getElementById('overlay-title').innerText = "FALL ABGESCHLOSSEN";
            document.getElementById('overlay-msg').innerText = "Mandat erfolgreich bearbeitet.";
            savedProgress[activeCase.id] = 100;
            localStorage.setItem('junior_lawyer_save_v15_1', JSON.stringify(savedProgress));
        }

        function addMsg(cls, txt, type) {
            const d = document.createElement('div');
            d.className = `message ${cls} ${type||''}`;
            d.innerText = txt;
            chatWindow.appendChild(d);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function updateTrust() {
            if(!isExamMode) {
                // Bar acts as Trust
                const b = document.getElementById('trust-bar');
                b.style.width = trust + "%";
                b.style.background = trust > 70 ? 'var(--accent-green)' : (trust < 30 ? 'var(--accent-red)' : 'var(--accent-blue)');
            }
        }

        function showArchive() {
            menuScreen.style.display = 'none';
            archiveScreen.style.display = 'flex';
            document.getElementById('archive-title').innerText = "Musterl√∂sungen";
            archiveContent.innerHTML = '';
            examResultFooter.style.display = 'none';
            document.querySelector('#archive-screen .btn-back').style.display = 'block';
            
            cases.forEach(c => {
                const grp = document.createElement('div');
                grp.className = 'archive-group';
                grp.innerHTML = `<h3>${c.title}</h3>`;
                const sol = document.createElement('div');
                sol.className = 'archive-item';
                sol.innerHTML = `<div class="archive-q">Musterl√∂sung</div><div class="archive-sol">${c.detailed_solution}</div>`;
                grp.appendChild(sol);
                archiveContent.appendChild(grp);
            });
        }

        function exitToMenu() {
            stopTimer();
            menuScreen.style.display = 'flex';
            gameScreen.style.display = 'none';
            archiveScreen.style.display = 'none';
            gameHeader.style.display = 'none';
            document.getElementById('timer-container').style.display = 'none';
            document.getElementById('difficulty-screen').style.display = 'none';
            overlay.style.display = 'none';
            renderMenu();
        }

        function hardReset() { if(confirm("Reset?")) { localStorage.removeItem('junior_lawyer_save_v15_1'); location.reload(); } }
        function devUnlock() { cases.forEach(c => savedProgress[c.id]=100); localStorage.setItem('junior_lawyer_save_v15_1', JSON.stringify(savedProgress)); location.reload(); }

        window.onload = init;
    </script>
</body>
</html>
